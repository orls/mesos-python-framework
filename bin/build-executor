#!/usr/bin/env bash

#
# Script for building the mesos-py-test executor tar file. This script will generate
# a file in ../dist/mesos-py-test-{git hash}.tar.gz to be uploaded to somewhere accessible
# from your mesos cluster.
# 
# If you have uncommitted changes, the script will do nothing with the FORCE
# environment variable set.
#

set -e

cd $(dirname $(dirname $0))

EXTRA_SUFFIX=''
# Help the user out by warning them of uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
    if [ ! "$FORCE" ]; then
        echo "You appear to have uncommitted changes, using additional hash of your diff"
        MD5APP=md5sum
        if [ -z "$(which $MD5APP)" ]; then
            MD5APP="md5"
        fi
        EXTRA_SUFFIX="-uncommitted-$(git diff | $MD5APP)"
    fi
fi

# Figure out the git revision
GIT_REV=$(git rev-parse HEAD)
SOURCE_DIR=$(pwd)
TAR_NAME="mesos-py-test-$GIT_REV$EXTRA_SUFFIX"
TMP_DIR=$(mktemp -d -t XXXXXX)

echo "Using temporary directory $TMP_DIR"

# Create a copy of the repository
mkdir -p dist
pushd dist > /dev/null
    pushd $TMP_DIR  > /dev/null
        mkdir build
        cp -r $SOURCE_DIR/** build/

        pushd build  > /dev/null
            rm -rf *.pyc
            rm -rf bin/env
            rm -rf dist
        popd  > /dev/null

        mv build $TAR_NAME
        tar -cvf $TAR_NAME.tar.gz $TAR_NAME
    popd  > /dev/null

    mv $TMP_DIR/$TAR_NAME.tar.gz ./

    echo "Cleaning up temporary directory"
    rm -rf $TMP_DIR
popd  > /dev/null

echo ""
echo "Executor built to $(pwd ./dist)$TAR_NAME.tar.gz"
